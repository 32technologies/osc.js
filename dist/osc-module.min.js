/*! osc.js 1.1.4, Copyright 2015 Colin Clark | github.com/colinbdclark/osc.js */

!function(a,b){"object"==typeof exports?(a.osc=exports,b(exports,require("slip"),require("EventEmitter"))):"function"==typeof define&&define.amd?define(["exports","slip","EventEmitter"],function(c,d,e){return a.osc=c,a.osc,b(c,d,e)}):(a.osc={},b(a.osc,slip,EventEmitter))}(this,function(a,b,c){var d=d||{};!function(){"use strict";var a;d.SECS_70YRS=2208988800,d.TWO_32=4294967296,d.defaults={metadata:!1,unpackSingleArgs:!0},d.isBufferEnv="undefined"!=typeof Buffer,d.isArray=function(a){return a&&"[object Array]"===Object.prototype.toString.call(a)},d.isTypedArrayView=function(a){return a.buffer&&a.buffer instanceof ArrayBuffer},d.isBuffer=function(a){return d.isBufferEnv&&a instanceof Buffer},d.dataView=function(b){return b instanceof DataView?b:"undefined"!=typeof a&&b instanceof a?b:d.isBufferEnv&&b instanceof Buffer?new a(b):b.buffer?new DataView(b.buffer):b instanceof ArrayBuffer?new DataView(b):new DataView(new Uint8Array(b))},d.byteArray=function(a){if(a instanceof Uint8Array)return a;var b=a.buffer?a.buffer:a;if("undefined"==typeof a.length||"string"==typeof a)throw new Error("Can't wrap a non-array-like object as Uint8Array. Object was: "+JSON.stringify(a,null,2));return new Uint8Array(b)},d.makeByteArray=function(a){return d.isBufferEnv?new Buffer(a):new Uint8Array(a)},d.copyByteArray=function(a,b,c){if(d.isTypedArrayView(a)&&d.isTypedArrayView(b))b.set(a,c);else if(d.isBuffer(a)&&d.isBuffer(b))a.copy(b,c);else for(var e=void 0===c?0:c,f=Math.min(b.length-c,a.length),g=0,h=e;f>g;g++,h++)b[h]=a[g];return b},d.readString=function(a,b){for(var c=[],d=b.idx;d<a.byteLength;d++){var e=a.getUint8(d);if(0===e){d++;break}c.push(e)}return d=d+3&-4,b.idx=d,String.fromCharCode.apply(null,c)},d.writeString=function(a){for(var b=a+"\x00",c=b.length,d=c+3&-4,e=new Uint8Array(d),f=0;f<b.length;f++){var g=b.charCodeAt(f);e[f]=g}return e},d.readPrimitive=function(a,b,c,d){var e=a[b](d.idx,!1);return d.idx+=c,e},d.writePrimitive=function(a,b,c,d,e){e=void 0===e?0:e;var f;return b?f=new Uint8Array(b.buffer):(f=new Uint8Array(d),b=new DataView(f.buffer)),b[c](e,a,!1),f},d.readInt32=function(a,b){return d.readPrimitive(a,"getInt32",4,b)},d.writeInt32=function(a,b,c){return d.writePrimitive(a,b,"setInt32",4,c)},d.readFloat32=function(a,b){return d.readPrimitive(a,"getFloat32",4,b)},d.writeFloat32=function(a,b,c){return d.writePrimitive(a,b,"setFloat32",4,c)},d.readFloat64=function(a,b){return d.readPrimitive(a,"getFloat64",8,b)},d.writeFloat64=function(a,b,c){return d.writePrimitive(a,b,"setFloat64",8,c)},d.readChar32=function(a,b){var c=d.readPrimitive(a,"getUint32",4,b);return String.fromCharCode(c)},d.writeChar32=function(a,b,c){var e=a.charCodeAt(0);return void 0===e||-1>e?void 0:d.writePrimitive(e,b,"setUint32",4,c)},d.readBlob=function(a,b){var c=d.readInt32(a,b),e=c+3&-4,f=new Uint8Array(a.buffer,b.idx,c);return b.idx+=e,f},d.writeBlob=function(a){a=d.byteArray(a);var b=a.byteLength,c=b+3&-4,e=4,f=c+e,g=new Uint8Array(f),h=new DataView(g.buffer);return d.writeInt32(b,h),g.set(a,e),g},d.readMIDIBytes=function(a,b){var c=new Uint8Array(a.buffer,b.idx,4);return b.idx+=4,c},d.writeMIDIBytes=function(a){a=d.byteArray(a);var b=new Uint8Array(4);return b.set(a),b},d.readColor=function(a,b){var c=new Uint8Array(a.buffer,b.idx,4),d=c[3]/255;return b.idx+=4,{r:c[0],g:c[1],b:c[2],a:d}},d.writeColor=function(a){var b=Math.round(255*a.a),c=new Uint8Array([a.r,a.g,a.b,b]);return c},d.readTrue=function(){return!0},d.readFalse=function(){return!1},d.readNull=function(){return null},d.readImpulse=function(){return 1},d.readTimeTag=function(a,b){var c=d.readPrimitive(a,"getUint32",4,b),e=d.readPrimitive(a,"getUint32",4,b),f=0===c&&1===e?Date.now():d.ntpToJSTime(c,e);return{raw:[c,e],"native":f}},d.writeTimeTag=function(a){var b=a.raw?a.raw:d.jsToNTPTime(a["native"]),c=new Uint8Array(8),e=new DataView(c.buffer);return d.writeInt32(b[0],e,0),d.writeInt32(b[1],e,4),c},d.timeTag=function(a){a=a||0;var b=Date.now()/1e3,c=Math.floor(b),e=b-c,f=Math.floor(a),g=a-f,h=e+g;if(h>1){var i=Math.floor(h),j=h-i;f+=i,h=j}var k=c+f+d.SECS_70YRS,l=Math.round(d.TWO_32*h);return{raw:[k,l]}},d.ntpToJSTime=function(a,b){var c=a-d.SECS_70YRS,e=b/d.TWO_32,f=1e3*(c+e);return f},d.jsToNTPTime=function(a){var b=a/1e3,c=Math.floor(b),e=b-c,f=c+d.SECS_70YRS,g=Math.round(d.TWO_32*e);return[f,g]},d.readArguments=function(a,b,c){var e=d.readString(a,c);if(0!==e.indexOf(","))throw new Error("A malformed type tag string was found while reading the arguments of an OSC message. String was: "+e," at offset: "+c.idx);var f=e.substring(1).split(""),g=[];return d.readArgumentsIntoArray(g,f,e,a,b,c),g},d.readArgument=function(a,b,c,e,f){var g=d.argumentTypes[a];if(!g)throw new Error("'"+a+"' is not a valid OSC type tag. Type tag string was: "+b);var h=g.reader,i=d[h](c,f);return e.metadata&&(i={type:a,value:i}),i},d.readArgumentsIntoArray=function(a,b,c,e,f,g){for(var h=0;h<b.length;){var i,j=b[h];if("["===j){var k=b.slice(h+1),l=k.indexOf("]");if(0>l)throw new Error("Invalid argument type tag: an open array type tag ('[') was found without a matching close array tag ('[]'). Type tag was: "+c);var m=k.slice(0,l);i=d.readArgumentsIntoArray([],m,c,e,f,g),h+=l+2}else i=d.readArgument(j,c,e,f,g),h++;a.push(i)}return a},d.writeArguments=function(a,b){var c=d.collectArguments(a,b);return d.joinParts(c)},d.joinParts=function(a){for(var b=d.makeByteArray(a.byteLength),c=a.parts,e=0,f=0;f<c.length;f++){var g=c[f];d.copyByteArray(g,b,e),e+=g.length}return b},d.addDataPart=function(a,b){b.parts.push(a),b.byteLength+=a.length},d.collectArguments=function(a,b,c){d.isArray(a)||(a=[a]),c=c||{byteLength:0,parts:[]},b.metadata||(a=d.annotateArguments(a));for(var e=",",f=c.parts.length,g=0;g<a.length;g++){var h=a[g],i=h.type,j=d.argumentTypes[i].writer;if(e+=h.type,j){var k=d[j](h.value);d.addDataPart(k,c)}}var l=d.writeString(e);return c.byteLength+=l.byteLength,c.parts.splice(f,0,l),c},d.readMessage=function(a,b,c){b=b||d.defaults;var e=d.dataView(a);c=c||{idx:0};var f=d.readString(e,c);return d.readMessageContents(f,e,b,c)},d.readMessageContents=function(a,b,c,e){if(0!==a.indexOf("/"))throw new Error("A malformed OSC address was found while reading an OSC message. String was: "+a);var f=d.readArguments(b,c,e);return{address:a,args:1===f.length&&c.unpackSingleArgs?f[0]:f}},d.collectMessageParts=function(a,b,c){return c=c||{byteLength:0,parts:[]},d.addDataPart(d.writeString(a.address),c),d.collectArguments(a.args,b,c)},d.writeMessage=function(a,b){b=b||d.defaults;var c=d.collectMessageParts(a,b);return d.joinParts(c)},d.readBundle=function(a,b,c){return d.readPacket(a,b,c)},d.collectBundlePackets=function(a,b,c){c=c||{byteLength:0,parts:[]},d.addDataPart(d.writeString("#bundle"),c),d.addDataPart(d.writeTimeTag(a.timeTag),c);for(var e=0;e<a.packets.length;e++){var f=a.packets[e],g=f.address?d.collectMessageParts:d.collectBundlePackets,h=g(f,b);c.byteLength+=h.byteLength,d.addDataPart(d.writeInt32(h.byteLength),c),c.parts=c.parts.concat(h.parts)}return c},d.writeBundle=function(a,b){if(a.timeTag&&a.packets){b=b||d.defaults;var c=d.collectBundlePackets(a,b);return d.joinParts(c)}},d.readBundleContents=function(a,b,c,e){for(var f=d.readTimeTag(a,c),g=[];c.idx<e;){var h=d.readInt32(a,c),i=c.idx+h,j=d.readPacket(a,b,c,i);g.push(j)}return{timeTag:f,packets:g}},d.readPacket=function(a,b,c,e){var f=d.dataView(a);e=void 0===e?f.byteLength:e,c=c||{idx:0};var g=d.readString(f,c),h=g[0];if("#"===h)return d.readBundleContents(f,b,c,e);if("/"===h)return d.readMessageContents(g,f,b,c);throw new Error("The header of an OSC packet didn't contain an OSC address or a #bundle string. Header was: "+g)},d.writePacket=function(a,b){var c=a.address?d.writeMessage:d.writeBundle;return c(a,b)},d.argumentTypes={i:{reader:"readInt32",writer:"writeInt32"},f:{reader:"readFloat32",writer:"writeFloat32"},s:{reader:"readString",writer:"writeString"},S:{reader:"readString",writer:"writeString"},b:{reader:"readBlob",writer:"writeBlob"},t:{reader:"readTimeTag",writer:"writeTimeTag"},T:{reader:"readTrue"},F:{reader:"readFalse"},N:{reader:"readNull"},I:{reader:"readImpulse"},d:{reader:"readFloat64",writer:"writeFloat64"},c:{reader:"readChar32",writer:"writeChar32"},r:{reader:"readColor",writer:"writeColor"},m:{reader:"readMIDIBytes",writer:"writeMIDIBytes"}},d.inferTypeForArgument=function(a){var b=typeof a;switch(b){case"boolean":return a?"T":"F";case"string":return"s";case"number":return"f";case"undefined":return"N";case"object":if(null===a)return"N";if(a instanceof Uint8Array||a instanceof ArrayBuffer||d.isBufferEnv&&a instanceof Buffer)return"b"}throw new Error("Can't infer OSC argument type for value: "+JSON.stringify(a,null,2))},d.annotateArguments=function(a){d.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var e,f=a[c];if("object"==typeof f&&f.type&&void 0!==f.value)e=f;else{var g=d.inferTypeForArgument(f);e={type:g,value:f}}b.push(e)}return b},"undefined"!=typeof module&&module.exports&&(d.isBufferEnv&&(a=require("buffer-dataview")),module.exports=d)}();var d=d||require("./osc.js"),b=b||require("slip"),c=c||require("events").EventEmitter;!function(){"use strict";d.firePacketEvents=function(a,b,c){b.address?a.emit("message",b,c):d.fireBundleEvents(a,b,c)},d.fireBundleEvents=function(a,b,c){a.emit("bundle",b,c);for(var e=0;e<b.packets.length;e++){var f=b.packets[e];d.firePacketEvents(a,f,b.timeTag)}},d.Port=function(a){this.options=a||{},this.on("data",this.decodeOSC.bind(this))};var a=d.Port.prototype=Object.create(c.prototype);a.constructor=d.Port,a.send=function(a){var b=Array.prototype.slice.call(arguments),c=this.encodeOSC(a);b[0]=c,this.sendRaw.apply(this,b)},a.encodeOSC=function(a){a=a.buffer?a.buffer:a;var b=d.writePacket(a,this.options);return b},a.decodeOSC=function(a){this.emit("raw",a);var b=d.readPacket(a,this.options);this.emit("osc",b),d.firePacketEvents(this,b)},d.SLIPPort=function(a){var c=this,d=this.options=a||{};d.useSLIP=void 0===d.useSLIP?!0:d.useSLIP,this.decoder=new b.Decoder({onMessage:this.decodeOSC.bind(this),onError:function(a){c.emit("error",a)}});var e=d.useSLIP?this.decodeSLIPData:this.decodeOSC;this.on("data",e.bind(this))},a=d.SLIPPort.prototype=Object.create(d.Port.prototype),a.constructor=d.SLIPPort,a.encodeOSC=function(a){a=a.buffer?a.buffer:a;var c=d.writePacket(a,this.options);return b.encode(c)},a.decodeSLIPData=function(a){this.decoder.decode(a)},d.relay=function(a,b,c,d,e,f){c=c||"message",d=d||"send",e=e||function(){},f=f?[null].concat(f):[];var g=function(a){f[0]=a,a=e(a),b[d].apply(b,f)};return a.on(c,g),{eventName:c,listener:g}},d.relayPorts=function(a,b,c){var e=c.raw?"raw":"osc",f=c.raw?"sendRaw":"send";return d.relay(a,b,e,f,c.transform)},d.stopRelaying=function(a,b){a.removeListener(b.eventName,b.listener)},d.Relay=function(a,b,c){var d=this.options=c||{};d.raw=!1,this.port1=a,this.port2=b,this.listen()},a=d.Relay.prototype=Object.create(c.prototype),a.constructor=d.Relay,a.open=function(){this.port1.open(),this.port2.open()},a.listen=function(){this.port1Spec&&this.port2Spec&&this.close(),this.port1Spec=d.relayPorts(this.port1,this.port2,this.options),this.port2Spec=d.relayPorts(this.port2,this.port1,this.options);var a=this.close.bind(this);this.port1.on("close",a),this.port2.on("close",a)},a.close=function(){d.stopRelaying(this.port1,this.port1Spec),d.stopRelaying(this.port2,this.port2Spec),this.emit("close",this.port1,this.port2)},"undefined"!=typeof module&&module.exports&&(module.exports=d)}();var d=d;return function(){"use strict";d.WebSocketPort=function(a){d.Port.call(this,a),this.on("open",this.listen.bind(this))};var a=d.WebSocketPort.prototype=Object.create(d.Port.prototype);a.constructor=d.WebSocketPort,a.open=function(){this.socket=new WebSocket(this.options.url),this.socket.binaryType="arraybuffer";var a=this;this.socket.onopen=function(){a.emit("open",a.socket)}},a.listen=function(){var a=this;this.socket.onmessage=function(b){a.emit("data",b.data)},this.socket.onerror=function(b){a.emit("error",b)},this.socket.onclose=function(b){a.emit("close",b)},a.emit("ready")},a.sendRaw=function(a){this.socket&&this.socket.send(a.buffer)},a.close=function(a,b){this.socket.close(a,b)}}(),d});